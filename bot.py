import asyncio
import logging
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.enums import ParseMode

from db.config import settings
from db.database import Database
from services.lm_handler import LLMHandler
from services.query_processor import QueryProcessor


logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

router = Router()

db: Database = None
query_processor: QueryProcessor = None


@router.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = """
    üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç–∞.

    –Ø –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    ‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ?
    ‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ —É –∫—Ä–µ–∞—Ç–æ—Ä–∞ —Å id ... –≤—ã—à–ª–æ —Å 1 –ø–æ 5 –Ω–æ—è–±—Ä—è 2025?
    ‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –Ω–∞–±—Ä–∞–ª–æ –±–æ–ª—å—à–µ 100000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?
    ‚Ä¢ –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤—ã—Ä–æ—Å–ª–∏ –≤—Å–µ –≤–∏–¥–µ–æ 28 –Ω–æ—è–±—Ä—è 2025?
    ‚Ä¢ –°–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–µ–æ –ø–æ–ª—É—á–∞–ª–∏ –Ω–æ–≤—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã 27 –Ω–æ—è–±—Ä—è 2025?

    –ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!
    """
    await message.answer(welcome_text)


@router.message()
async def handle_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
        processing_msg = await message.answer("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        result = await query_processor.process_query(message.text)

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        await processing_msg.delete()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await message.answer(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")

    except Exception as e:
        logger.error(f"Error handling message: {e}")
        await message.answer(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}")


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    global db, query_processor

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
    bot = Bot(token=settings.TELEGRAM_BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher()
    dp.include_router(router)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db = Database(settings.DATABASE_URL)
    await db.connect()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM
    llm_handler = LLMHandler()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    query_processor = QueryProcessor(db, llm_handler)

    logger.info("Bot is starting...")

    try:
        await dp.start_polling(bot)
    finally:
        await db.disconnect()
        await bot.session.close()


if __name__ == "__main__":
    asyncio.run(main())
